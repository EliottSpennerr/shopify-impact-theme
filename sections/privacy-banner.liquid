document.addEventListener("DOMContentLoaded", () => {
  const privacyBar = document.querySelector("privacy-bar");

  if (!privacyBar) return;

  // Ladda Shopify Customer Privacy API
  window.Shopify.loadFeatures(
    [
      {
        name: "consent-tracking-api",
        version: "0.1",
      },
    ],
    (error) => {
      if (error) {
        console.error("Error loading Customer Privacy API", error);
        return;
      }

      const customerPrivacy = window.Shopify.customerPrivacy;

      // Kontrollera om något samtycke redan finns
      const hasGivenConsent =
        customerPrivacy.preferencesProcessingAllowed() ||
        customerPrivacy.analyticsProcessingAllowed() ||
        customerPrivacy.marketingAllowed();

      if (!hasGivenConsent) {
        privacyBar.hidden = false;
      }

      // "Acceptera"-knappen
      privacyBar.querySelector('[data-action="accept"]')?.addEventListener("click", () => {
        customerPrivacy.setTrackingConsent(
          {
            analytics: true,
            marketing: true,
            preferences: true,
          },
          () => {
            console.log("Consent accepted");
            privacyBar.hidden = true;
          }
        );
      });

      // "Avböj"-knappen
      privacyBar.querySelector('[data-action="decline"]')?.addEventListener("click", () => {
        customerPrivacy.setTrackingConsent(
          {
            analytics: false,
            marketing: false,
            preferences: false,
          },
          () => {
            console.log("Consent declined");
            privacyBar.hidden = true;
          }
        );
      });

      // "Stäng"-knappen (göm utan att spara val)
      privacyBar.querySelector('[data-action="close"]')?.addEventListener("click", () => {
        privacyBar.hidden = true;
      });

      // Om samtycke ändras på annat håll
      document.addEventListener("visitorConsentCollected", (event) => {
        console.log("Consent event fired:", event.detail);
        privacyBar.hidden = true;
      });
    }
  );
});
